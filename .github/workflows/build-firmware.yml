name: Build XIAO Minimal Firmware

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build-xiao-minimal:
    runs-on: ubuntu-latest
    env:
      NCS_VERSION: v2.7.0
      FIRMWARE_DIR: omi/firmware
      ZEPHYR_SDK_VERSION: 0.16.5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            cmake ninja-build gperf ccache dfu-util device-tree-compiler xz-utils file wget
          python -m pip install --upgrade pip
          python -m pip install --no-cache-dir west

      - name: Fetch nRF Connect SDK
        run: |
          cd "${FIRMWARE_DIR}"
          west init -m https://github.com/nrfconnect/sdk-nrf --mr "${NCS_VERSION}" "${NCS_VERSION}"
          cd "${NCS_VERSION}"
          west update -o=--depth=1 -n
          west blobs fetch hal_nordic
          west zephyr-export
          python -m pip install --no-cache-dir -r zephyr/scripts/requirements.txt

      - name: Install Zephyr SDK
        run: |
          ZEPHYR_SDK_INSTALL_DIR="${GITHUB_WORKSPACE}/.zephyr-sdk"
          SDK_TARBALL="zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64.tar.xz"
          SDK_URL="https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v${ZEPHYR_SDK_VERSION}/${SDK_TARBALL}"

          wget -q "${SDK_URL}" -O "${RUNNER_TEMP}/${SDK_TARBALL}"
          tar -C "${RUNNER_TEMP}" -xf "${RUNNER_TEMP}/${SDK_TARBALL}"
          mv "${RUNNER_TEMP}/zephyr-sdk-${ZEPHYR_SDK_VERSION}" "${ZEPHYR_SDK_INSTALL_DIR}"

      - name: Build xiao_minimal
        env:
          ZEPHYR_TOOLCHAIN_VARIANT: zephyr
        run: |
          export ZEPHYR_SDK_INSTALL_DIR="${GITHUB_WORKSPACE}/.zephyr-sdk"
          cd "${FIRMWARE_DIR}/${NCS_VERSION}"
          west build --pristine always ../xiao_minimal -- \
            -DNCS_TOOLCHAIN_VERSION="NONE" \
            -DCONF_FILE="${GITHUB_WORKSPACE}/${FIRMWARE_DIR}/xiao_minimal/prj.conf" \
            -DDTC_OVERLAY_FILE="${GITHUB_WORKSPACE}/${FIRMWARE_DIR}/xiao_minimal/xiao_ble_sense.overlay" \
            -DCMAKE_BUILD_TYPE="Release"

      - name: Upload UF2 artifact
        uses: actions/upload-artifact@v4
        with:
          name: xiao_minimal-uf2
          path: omi/firmware/v2.7.0/build/zephyr/zephyr.uf2
          if-no-files-found: error
